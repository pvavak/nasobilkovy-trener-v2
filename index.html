<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>N√°sobilkov√Ω tr√©ner ‚Äì 4.A</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--card:#111b2e;--muted:#9fb3c8;--text:#e6eef9;--pri:#60a5fa;--ok:#34d399;--bad:#f87171;--line:rgba(148,163,184,.28)}
    *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:22px;margin:6px 0 12px}
    .nav{display:flex;flex-wrap:wrap;gap:8px}
    .btn{padding:8px 14px;border:1px solid var(--line);border-radius:12px;background:#0e1a2c;color:var(--text);cursor:pointer}
    .btn.ok{background:linear-gradient(180deg,#34d399,#065f46);border-color:#178d68}
    .btn.pri{background:linear-gradient(180deg,#60a5fa,#1d4ed8);border-color:#2563eb}
    .btn.out{background:transparent}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .hd{padding:10px 14px;background:#0e1a2c;border-bottom:1px solid var(--line);font-weight:700}
    .bd{padding:14px}
    input[type=text],input[type=number]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0b1220;color:var(--text)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
    .muted{color:var(--muted)} .right{text-align:right}
    .row{display:flex;gap:10px;align-items:center}
    .kpi{display:inline-block;margin:4px 10px 0 0;padding:8px 12px;border:1px solid var(--line);border-radius:12px;background:#0b1220}
    .bars{display:flex;gap:6px;align-items:flex-end;height:120px;padding:6px;border:1px solid var(--line);border-radius:12px;background:#0b1220}
    .bar{width:20px;background:linear-gradient(180deg,#34d399,#065f46);border:1px solid rgba(52,211,153,.55);border-radius:6px 6px 0 0}
    .hint{padding:12px;border:1px dashed var(--line);border-radius:12px;background:#0c1628}
    .hidden{display:none}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1220}
    .confetti{position:fixed;top:-20px;font-size:24px;animation:fall 2.2s linear forwards}
    @keyframes fall{to{transform:translateY(110vh) rotate(360deg);opacity:.8}}
    .footer{padding:28px 0 10px;color:var(--muted);text-align:center;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>N√°sobilkov√Ω tr√©ner</h1>
        <div class="muted">4. roƒçn√≠k ‚Ä¢ mal√° n√°sobilka (1‚Äì10) ‚Ä¢ re≈æim <span class="pill">len na≈°a trieda</span></div>
      </div>
      <div class="nav">
        <button type="button" class="btn pri" onclick="show('section-main')">Cviƒçenie</button>
        <button type="button" class="btn pri" onclick="show('section-test')">1-min test</button>
        <button type="button" class="btn" onclick="show('section-analytics')">Anal√Ωza</button>
        <button type="button" class="btn" onclick="show('section-leader')">Rebr√≠ƒçek</button>
        <button type="button" class="btn out" onclick="toggleTheme()">üåì</button>
      </div>
    </div>

    <!-- CVIƒåENIE -->
    <section class="card" id="section-main">
      <div class="hd">Cviƒçenie ‚Äì vyber rodiny</div>
      <div class="bd">
        <div class="row" style="flex-wrap:wrap;margin-bottom:8px">
          <span class="muted">Akt√≠vne:</span>
          <div id="familiesBtns"></div>
        </div>
        <div class="row" style="flex-wrap:wrap;margin-bottom:16px">
          <button type="button" class="btn" onclick="selectFamilies([2,3,4])">√ó2 √ó3 √ó4</button>
          <button type="button" class="btn" onclick="selectFamilies([5,10])">√ó5 √ó10</button>
          <button type="button" class="btn" onclick="selectFamilies([6,7,8,9])">√ó6 √ó7 √ó8 √ó9</button>
          <button type="button" class="btn out" onclick="families=new Set([2,3,4,5,6,7,8,9,10]);renderFamilies()">V≈°etko</button>
        </div>
        <div class="grid">
          <div class="card">
            <div class="hd">Pr√≠klad</div>
            <div class="bd">
              <div class="row" style="gap:12px;align-items:flex-end">
                <div id="qBox" style="font-size:28px;font-weight:700">7 √ó 8 = ?</div>
                <input type="number" id="ans" placeholder="tvoja odpoveƒè" style="max-width:160px" />
                <button type="button" class="btn pri" onclick="check()">Skontrolova≈•</button>
                <span id="feedback" class="pill hidden">Spr√°vne!</span>
              </div>
              <div class="muted" id="tip" style="margin-top:10px"></div>
              <div style="margin-top:12px">
                <span class="kpi" id="statRight">0 spr√°vne</span>
                <span class="kpi" id="statTotal">0 pokusov</span>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="hd">Teplotn√° mapa (1‚Äì10)</div>
            <div class="bd" id="heat"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- TEST -->
    <section class="card hidden" id="section-test">
      <div class="hd">1-min test</div>
      <div class="bd">
        <div class="row" style="gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <label class="row"><input type="checkbox" id="timeStrict" checked style="margin-right:8px"> pr√≠sny limit 60 s</label>
          <button type="button" class="btn ok" id="beginTest">Spusti≈• test</button>
          <span class="kpi">‚è± <b id="timer">60 s</b></span>
          <span class="kpi">‚úÖ <b id="score">0 spr√°vne</b></span>
        </div>
        <div id="testBox" class="row" style="gap:12px;align-items:flex-end">
          <div id="testQ" style="font-size:28px;font-weight:700">‚Äî</div>
          <input type="number" id="testA" placeholder="odpoveƒè" style="width:140px" />
          <button type="button" class="btn pri" onclick="testAnswer()">OK</button>
        </div>
        <div id="testSummary" class="hidden" style="margin-top:14px"></div>
      </div>
    </section>

    <!-- ANAL√ùZA -->
    <section class="card hidden" id="section-analytics">
      <div class="hd">Anal√Ωza a odznaky</div>
      <div class="bd">
        <div id="anaKPI" style="margin-bottom:10px" class="row"></div>
        <div class="muted small" style="margin:6px 0">Posledn√Ωch 10 testov (z 100):</div>
        <div class="bars" id="anaBars"></div>
        <div class="muted small" style="margin:10px 0">Odznaky:</div>
        <div class="row" id="anaBadges" style="flex-wrap:wrap"></div>
      </div>
    </section>

    <!-- REBR√çƒåEK -->
    <section class="card hidden" id="section-leader">
      <div class="hd">Rebr√≠ƒçek (len na≈°a trieda)</div>
      <div class="bd">
        <div class="grid">
          <div class="card">
            <div class="hd">M√¥j profil</div>
            <div class="bd">
              <div class="row" style="gap:8px">
                <div style="flex:1">
                  <div class="muted">Prez√Ωvka</div>
                  <input id="nick" type="text" placeholder="napr. KometaMarek" />
                </div>
                <div style="width:160px">
                  <div class="muted">K√≥d triedy</div>
                  <input id="classCode" type="text" value="4A2025" readonly />
                </div>
              </div>
              <div class="row" style="gap:8px;margin-top:8px">
                <div style="flex:1">
                  <div class="muted">Podpis (meno/prez√Ωvka)</div>
                  <input id="signature" type="text" placeholder="napr. Marek" />
                </div>
                <div style="width:160px">
                  <div class="muted">PIN triedy</div>
                  <input id="pin" type="text" placeholder="7425" />
                </div>
              </div>
              <div class="row" style="gap:8px;margin-top:10px">
                <button type="button" class="btn ok" id="saveProfile">Ulo≈æi≈• profil</button>
                <span class="muted" id="leaderInfo">Najprv spusti 1-min test.</span>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hd">Odoslanie v√Ωsledku & naƒç√≠tanie TOP</div>
            <div class="bd">
              <div class="row" style="gap:8px;flex-wrap:wrap">
                <button type="button" class="btn pri" id="submitScore">Odosla≈• posledn√Ω 1-min v√Ωsledok</button>
                <button type="button" class="btn" id="loadTop">Naƒç√≠ta≈• rebr√≠ƒçek</button>
              </div>
              <div class="muted" style="margin-top:8px">Zobrazuj√∫ sa len prez√Ωvky. Podpis ide len do tabuƒæky uƒçiteƒæa.</div>
              <table style="margin-top:10px">
                <thead><tr><th>Por.</th><th>Prez√Ωvka</th><th>Sk√≥re</th><th>D√°tum</th></tr></thead>
                <tbody id="leaderBody"><tr><td colspan="4" class="muted">Zatiaƒæ niƒç.</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="footer">
      ¬© 2025 N√°sobilkov√Ω tr√©ner ‚Ä¢ offline PWA ‚Ä¢ len pre na≈°u triedu
    </div>
  </div>

<script>
/* ====== KON≈†TANTY (TVOJE HODNOTY) ====== */
const API_URL     = 'https://script.google.com/macros/s/AKfycbzYFssm-b7ZHYX9POrYeiwSH-84wDJHI0x-6GA6KTLxWlQ2sUKEfvFWyUtP8ZTp-R5KTg/exec';
const CLASS_CODE  = '4A2025';
const CLASS_TOKEN = 'tajny-token-4A';
const CLASS_PIN   = '7425';

/* ====== POMOCN√â FUNKCIE ====== */
function show(id){ for(const s of ['section-main','section-test','section-analytics','section-leader']){ document.getElementById(s).classList.toggle('hidden', s!==id); } }
function toggleTheme(){ document.documentElement.style.filter = (document.documentElement.style.filter?'':'contrast(1.02) saturate(1.02)'); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function dropConfetti(){ for(let i=0;i<60;i++){ const s=document.createElement('div'); s.className='confetti'; s.textContent=['üéâ','‚ú®','üéà','üéä'][Math.floor(Math.random()*4)]; s.style.left=Math.floor(Math.random()*100)+'vw'; s.style.animationDelay=(Math.random()*0.6)+'s'; document.body.appendChild(s); setTimeout(()=>s.remove(),2300);} }

/* ====== PROFIL / LOK√ÅLNE D√ÅTA (safe) ====== */
const PROF_KEY='leaderProfileV1', HEAT_KEY='heatV1', HIST_KEY='testHistoryV1', STREAK_KEY='streakDaysV1';

function safeGet(key, fallback){
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : (fallback ?? null); }
  catch(e){ console.warn('localStorage get error', e); return (fallback ?? null); }
}
function safeSet(key, value){
  try { localStorage.setItem(key, JSON.stringify(value)); return true; }
  catch(e){ console.warn('localStorage set error', e); alert('Nepodarilo sa ulo≈æi≈• do zariadenia. Povoƒæ ukladanie d√°t alebo sk√∫s in√Ω prehliadaƒç.'); return false; }
}

function saveProfile(p){ return safeSet(PROF_KEY, p); }
function loadProfile(){ return safeGet(PROF_KEY, {}) || {}; }

function getDeviceId(){
  const k='deviceIdV1';
  let id = safeGet(k, null);
  if(!id){ id='d-'+Math.random().toString(36).slice(2)+'-'+Date.now(); safeSet(k, id); }
  return id;
}
function todayYmd(){ const d=new Date(); return d.toISOString().slice(0,10); }
function markStreakToday(){ const s=new Set(safeGet(STREAK_KEY, [])||[]); s.add(todayYmd()); safeSet(STREAK_KEY, [...s]); }
function computeStreak(){ const set=new Set(safeGet(STREAK_KEY, [])||[]); let cnt=0; const now=new Date();
  for(let i=0;i<400;i++){ const d=new Date(now); d.setDate(now.getDate()-i); const y=d.toISOString().slice(0,10); if(set.has(y)) cnt++; else break; } return cnt; }

/* ====== CVIƒåENIE ====== */
let families=new Set([6,7,8,9]); let cur=[7,8]; let right=0,total=0;
function renderFamilies(){ const root=document.getElementById('familiesBtns'); root.innerHTML=''; for(let n=2;n<=10;n++){ if(n===1) continue; const b=document.createElement('button'); b.type='button'; b.className='btn'+(families.has(n)?' ok':''); b.textContent='√ó'+n; b.onclick=()=>{ if(families.has(n)) families.delete(n); else families.add(n); renderFamilies(); next(); }; root.appendChild(b);} }
function selectFamilies(arr){ families=new Set(arr); renderFamilies(); next(); }
function next(){ const fa=[...families]; const a=fa[rand(0,fa.length-1)], b=rand(1,10); cur=[a,b]; document.getElementById('qBox').textContent = `${a} √ó ${b} = ?`; document.getElementById('ans').value=''; document.getElementById('feedback').classList.add('hidden'); document.getElementById('ans').focus(); }
function tipFor(a,b){ if(a===9) return '9√ó? ‚Üí 10√ó ‚àí 1√ó'; if([2,4,8].includes(a)) return '√ó2 ‚Üí zdvojn√°sob, √ó4 ‚Üí dvakr√°t, √ó8 ‚Üí trikr√°t'; if(a===5||a===10) return '√ó10 pridaj nulu, √ó5 je polovica z √ó10'; return 'Rozlo≈æ: '+a+'√ó'+b+' = '+a+'√ó('+(b-1)+'+1)'; }
function updateHeat(a,b,ok){ const H=safeGet(HEAT_KEY,{})||{}; const k=a+'x'+b; const o=H[k]||{right:0,total:0}; o.total++; if(ok) o.right++; H[k]=o; safeSet(HEAT_KEY,H); renderHeat(); }
function renderHeat(){ const box=document.getElementById('heat'); const H=safeGet(HEAT_KEY,{})||{}; let html='<table><thead><tr><th></th>'; for(let j=1;j<=10;j++) html+=`<th>√ó${j}</th>`; html+='</tr></thead><tbody>'; for(let i=1;i<=10;i++){ html+=`<tr><th>${i}</th>`; for(let j=1;j<=10;j++){ const o=H[i+'x'+j]||{right:0,total:0}; const acc=o.total? o.right/o.total : 0; const bg= o.total? `background: linear-gradient(90deg, rgba(52,211,153,${acc}) 0%, rgba(11,18,32,.6) 100%);` : 'background:#0b1220;'; html+=`<td style="${bg}">${o.total? Math.round(acc*100)+'%':''}</td>`; } html+='</tr>'; } html+='</tbody></table>'; box.innerHTML=html; }
function check(){ const a=cur[0], b=cur[1]; const v=Number(document.getElementById('ans').value||''); const ok=(a*b===v); document.getElementById('feedback').textContent = ok?'Spr√°vne!':'E≈°te raz'; document.getElementById('feedback').style.borderColor = ok ? '#178d68' : '#a61b2b'; document.getElementById('feedback').classList.remove('hidden'); document.getElementById('tip').textContent = tipFor(a,b); total++; if(ok) right++; document.getElementById('statRight').textContent = right+' spr√°vne'; document.getElementById('statTotal').textContent = total+' pokusov'; updateHeat(a,b,ok); setTimeout(next, 400); }

/* ====== TEST ====== */
let testState={running:false,left:60,score:0,total:0,cur:[0,0],timer:null,strict:true};
document.getElementById('beginTest').onclick=()=>{
  testState={running:true,left:60,score:0,total:0,cur:[0,0],timer:null,strict:document.getElementById('timeStrict').checked};
  document.getElementById('testSummary').classList.add('hidden');
  document.getElementById('timer').textContent = testState.strict? '60 s' : 'neobmedzene';
  document.getElementById('score').textContent = '0 spr√°vne';
  nextTestQ();
  if(testState.strict){
    testState.timer=setInterval(()=>{ testState.left--; document.getElementById('timer').textContent=testState.left+' s'; if(testState.left<=0) finishTest(); },1000);
  }
  document.getElementById('testA').focus();
};
function nextTestQ(){ const a=rand(2,10), b=rand(1,10); testState.cur=[a,b]; document.getElementById('testQ').textContent = `${a} √ó ${b} = ?`; document.getElementById('testA').value=''; }
function testAnswer(){ if(!testState.running) return; const v=Number(document.getElementById('testA').value||''); const ok=(testState.cur[0]*testState.cur[1]===v); if(ok) testState.score++; testState.total++; document.getElementById('score').textContent=testState.score+' spr√°vne'; nextTestQ(); }
function finishTest(){
  testState.running=false; if(testState.timer) clearInterval(testState.timer);
  window.lastTest={score:testState.score,total:testState.total,accuracy:(testState.total?testState.score/testState.total:0),ts:Date.now(),durationSec:(60-Math.max(0,testState.left))};
  const hist=loadHistory(); const prev=hist.length? hist[hist.length-1]:null; hist.push(window.lastTest); saveHistory(hist);
  const delta = prev? (window.lastTest.score - prev.score) : null;
  const best  = hist.reduce((m,x)=>Math.max(m,x.score),0);
  const avgSec= window.lastTest.total? (window.lastTest.durationSec/window.lastTest.total).toFixed(2) : '‚Äî';
  if(window.lastTest.score===20 || window.lastTest.score===best) dropConfetti();
  markStreakToday();
  const wf = weakFamilies().slice(0,2).map(n=>'√ó'+n).join(', ');
  const msg = (delta===null)?'Prv√Ω test ‚Äì super ≈°tart!'
      : (delta>2?`Skvel√Ω posun! +${delta}`:(delta>0?`Zlep≈°enie +${delta}`:(delta===0?'Stabiln√Ω v√Ωkon.':`Nevad√≠, d√°≈° to nabud√∫ce (‚àí${Math.abs(delta)})`)));
  const sum=document.getElementById('testSummary'); sum.classList.remove('hidden');
  sum.innerHTML = `
    <div class="hint">
      <div style="font-size:18px;font-weight:700;margin-bottom:6px">${msg}${window.lastTest.score===best?' (OSOB√ÅK!)':''}</div>
      <div class="row" style="flex-wrap:wrap">
        <span class="kpi">Sk√≥re: <b>${window.lastTest.score}/${window.lastTest.total}</b></span>
        <span class="kpi">Presnos≈•: <b>${Math.round((window.lastTest.accuracy||0)*100)}%</b></span>
        <span class="kpi">Priemer na pr√≠klad: <b>${avgSec} s</b></span>
        <span class="kpi">Najlep≈°ie: <b>${best}/20</b></span>
        <span class="kpi">Streak dn√≠: <b>${computeStreak()}</b></span>
      </div>
      <div class="muted" style="margin-top:8px">Tip: Dnes tr√©nuj slab√© fakty: <b>${wf||'‚Äî'}</b>.</div>
      <div class="row" style="gap:8px;margin-top:10px;flex-wrap:wrap">
        <button type="button" class="btn ok" onclick="families=new Set(weakFamilies());renderFamilies();show('section-main')">Tr√©nova≈• slab√© fakty</button>
        <button type="button" class="btn" onclick="openLeader()">Odosla≈• do rebr√≠ƒçka</button>
        <button type="button" class="btn out" onclick="renderAnalytics();show('section-analytics')">Anal√Ωza</button>
      </div>
    </div>`;
}
document.getElementById('testA').addEventListener('keydown',e=>{ if(e.key==='Enter') testAnswer(); });

/* ====== HIST√ìRIA & ANAL√ùZA ====== */
function loadHistory(){ return safeGet(HIST_KEY,[])||[]; }
function saveHistory(a){ safeSet(HIST_KEY, a.slice(-100)); }
function weakFamilies(){ const H=safeGet(HEAT_KEY,{})||{}; const acc={};
  for(let a=2;a<=10;a++){ let r=0,t=0; for(let b=1;b<=10;b++){ const o=H[a+'x'+b]; if(o){ r+=o.right||0; t+=o.total||0; } } acc[a]= t? (r/t) : 0; }
  return Object.entries(acc).sort((x,y)=>x[1]-y[1]).slice(0,3).map(([n,_])=>Number(n));
}
function renderAnalytics(){
  const hist=loadHistory(), anaKPI=document.getElementById('anaKPI'), anaBars=document.getElementById('anaBars'), anaBadges=document.getElementById('anaBadges');
  if(!hist.length){ anaKPI.innerHTML='<span class="muted">Zatiaƒæ ≈æiadne testy.</span>'; anaBars.innerHTML=''; anaBadges.innerHTML=''; return; }
  const best=hist.reduce((m,x)=>Math.max(m,x.score),0), last=hist[hist.length-1], prev=hist[hist.length-2]||null, delta=prev? last.score-prev.score:0, avg=(hist.reduce((s,x)=>s+x.score,0)/hist.length).toFixed(1);
  anaKPI.innerHTML=`<span class="kpi">Posledn√©: <b>${last.score}/20</b></span><span class="kpi">Priemer: <b>${avg}</b></span><span class="kpi">Osobn√© max: <b>${best}/20</b></span><span class="kpi">Zmena: <b>${delta>=0? '+'+delta: delta}</b></span>`;
  const recent=hist.slice(-10); anaBars.innerHTML=''; recent.forEach(x=>{ const b=document.createElement('div'); b.className='bar'; b.style.height=(6*x.score)+'%'; b.title=new Date(x.ts).toLocaleDateString()+' ‚Äì '+x.score+'/20'; anaBars.appendChild(b); });
  const badges=[]; if(hist.length>=1) badges.push('üéØ Prv√Ω test'); if(best>=15) badges.push('üî• 15/20'); if(best>=20) badges.push('üèÜ 20/20'); const st=computeStreak(); if(st>=3) badges.push('üìÖ Vytrvalec 3 dni'); if(st>=7) badges.push('üöÄ Vytrvalec 7 dn√≠'); if(hist.slice(-3).every(x=>x.score>=18)) badges.push('üí™ Stabilita 3√ó ‚â•18');
  anaBadges.innerHTML=badges.map(x=>`<span class="pill">${x}</span>`).join(' ');
}

/* ====== REBR√çƒåEK ====== */
function renderProfile(){
  const p=loadProfile();
  const nick=document.getElementById('nick'), cls=document.getElementById('classCode'), sig=document.getElementById('signature');
  if(nick) nick.value=p.nickname||''; if(cls){ cls.value=CLASS_CODE; cls.setAttribute('readonly','readonly'); } if(sig) sig.value=p.signature||'';
  const li=document.getElementById('leaderInfo'); if(li) li.textContent = window.lastTest? ('Posledn√Ω 1-min v√Ωsledok: '+window.lastTest.score+' z '+window.lastTest.total):'Najprv spusti 1-min test.';
}
const btnSaveProfile=document.getElementById('saveProfile');
if(btnSaveProfile){
  btnSaveProfile.addEventListener('click',()=>{
    const p={ nickname:(document.getElementById('nick')?.value||'').trim(),
              signature:(document.getElementById('signature')?.value||'').trim() };
    if(!p.nickname){ alert('Dopl≈à prez√Ωvku.'); return; }
    if(!p.signature){ alert('Dopl≈à podpis (meno/prez√Ωvka).'); return; }
    if(saveProfile(p)){ renderProfile(); alert('Profil ulo≈æen√Ω ‚úì'); }
  });
}

function openLeader(){ show('section-leader'); renderProfile(); }

async function sendScorePOST(body){
  const r = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!r.ok) throw new Error('HTTP '+r.status); const j=await r.json(); if(!j.ok) throw new Error('Server'); return j;
}
function sendScoreJSONP(body){
  return new Promise((resolve)=>{ const cb='cb'+Math.random().toString(36).slice(2); window[cb]= (d)=>{ delete window[cb]; resolve(d||{ok:false}); }; const qs=new URLSearchParams({...body, action:'add', callback:cb}); const s=document.createElement('script'); s.src=API_URL+'?'+qs.toString(); document.body.appendChild(s); });
}

const btnSubmit=document.getElementById('submitScore');
if(btnSubmit){
  btnSubmit.addEventListener('click', async ()=>{
    const p=loadProfile(), t=window.lastTest, pin=(document.getElementById('pin')?.value||'').trim();
    if(!t){ alert('Najprv urob 1-min test.'); return; }
    if(!p.nickname){ alert('Dopl≈à prez√Ωvku.'); return; }
    if(pin!==CLASS_PIN){ alert('Zl√Ω PIN triedy.'); return; }
    if(!p.signature){ alert('Dopl≈à svoj podpis (meno/prez√Ωvka).'); return; }
    if(!API_URL){ alert('Rebr√≠ƒçek je vypnut√Ω (API_URL je pr√°zdne).'); return; }
    const body={ classCode:CLASS_CODE, token:CLASS_TOKEN, nickname:p.nickname, score:t.score, total:t.total, deviceId:getDeviceId(), signature:p.signature };
    try{ await sendScorePOST(body); alert('Sk√≥re odoslan√© ‚úì'); }
    catch(e){ console.warn('POST fail',e); const d=await sendScoreJSONP(body); alert(d&&d.ok?'Sk√≥re odoslan√© ‚úì':'Odoslanie zlyhalo. Skontroluj API_URL/K√ìDY.'); }
  });
}

const btnLoadTop=document.getElementById('loadTop');
if(btnLoadTop){ btnLoadTop.addEventListener('click', ()=> loadTop()); }
function loadTop(){
  if(!API_URL){ alert('Rebr√≠ƒçek je vypnut√Ω (API_URL je pr√°zdne).'); return; }
  const cb='cb'+Math.random().toString(36).slice(2);
  window[cb]=(data)=>{ delete window[cb];
    const tbody=document.getElementById('leaderBody'); if(!tbody) return;
    tbody.innerHTML='';
    if(!data||!data.ok){ tbody.innerHTML='<tr><td colspan="4" class="muted">Chyba naƒç√≠tania.</td></tr>'; return; }
    data.top.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${escapeHtml(r.nickname||'‚Äî')}</td><td>${r.score}</td><td>${new Date(r.ts).toLocaleDateString()}</td>`; tbody.appendChild(tr); });
    const li=document.getElementById('leaderInfo'); if(li) li.textContent='Naƒç√≠tan√© '+data.top.length+' z√°znamov.';
  };
  const s=document.createElement('script');
  s.src = API_URL + '?action=top&limit=20&class=' + encodeURIComponent(CLASS_CODE) + '&token=' + encodeURIComponent(CLASS_TOKEN) + '&callback='+cb;
  document.body.appendChild(s);
}

/* ===== INIT + PWA ===== */
function init(){ renderFamilies(); next(); renderHeat(); renderProfile(); renderAnalytics(); }
init();
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }
</script>
</body>
</html>
